<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">

<dom-module id="idecanarias-ol3">
    <script src="//cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.3/proj4.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/ol3/3.3.0/ol.js"></script>
    <template>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ol3/3.3.0/ol.css" type="text/css">
        <style>
            :host {
                display: block;
                position: relative;
            }
            #map {
                height: 100%;
                width: 100%;
            }
        </style>
        <div id="map"></div>

        <iron-ajax
            id="ajax"
            handle-as="xml"
            on-response="handleResponse"
            last-response="{{ xmldata }}">
        </iron-ajax>

        <paper-material>
            <paper-input is="iron-input" bind-value="{{ texto }}"></paper-input>
            <paper-button on-click="setajax">Click me</paper-button>
        </paper-material>

        <template is="dom-repeat" items="{{ xmldata | nodeList('row') }}">
            <div><span>{{ item | nodeText('nombre') }}</span></div>
        </template>

        <p>[[ xmldata ]]</p>

    </template>
</dom-module>

<script>
    Polymer(
      {
        is: "idecanarias-ol3",

        map: null,

        attached: function() {
            this.async(function() {
                this.initialConfig();
            });
        },

        ready: function() {
            console.debug('ready');
        },

        setajax: function() {
            var texto = document.querySelector("input[is=iron-input]").value;
            this.$.ajax.url = "http://visor.grafcan.es/busquedas/toponimoxml/1/10/";
            this.$.ajax.params = {"texto": texto};
            if (texto) {
                this.$.ajax.generateRequest();
            }
        },

        initialConfig: function(){
            proj4.defs("EPSG:32628","+proj=utm +zone=28 +datum=WGS84 +units=m +no_defs");
            this.map = new ol.Map({
                target: this.$.map,
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.TileWMS({
                            url: "http://idecan3.grafcan.es/ServicioWMS/OrtoExpress?",
                            params: {
                                LAYERS: "ortoexpress",
                                FORMAT: "image/jpeg",
                                VERSION: "1.1.0" },
                            serverType: 'mapserver'
                        })
                    })
                ],
                view: new ol.View({
                    projection: 'EPSG:32628',
                    center: [392216.34, 3143997.71],
                    extent: [180000, 2900000, 680000, 3300000],
                    resolutions: [
                        650, 500, 250, 200,
                        75, 50, 20, 10, 5,
                        2.5, 2, 1.5, 1, 0.5, 0.2, 0.1],
                    units: 'm',
                    resolution: 650
                }),
                controls: ol.control.defaults({
                  attributionOptions: {
                    collapsible: false
                  }
                })
            });
        },

        handleResponse: function(data) {
            var x, i, xmlDoc;
            if (data) {
                xmlDoc = data.detail.response;
                x = xmlDoc.getElementsByTagName("row");
                for (i = 0; i < x.length; i++) {
                    console.debug(x[i].getElementsByTagName("nombre")[0].childNodes[0].nodeValue);
                }
                //console.debug(data.detail.response);
                //console.debug(xmlDoc.getElementsByTagName("rows"));
            }
        },

        nodeList: function(element, name) {
            return element ? [].slice.call(element.querySelectorAll(name)) : []
        },

        nodeText: function(element, name) {
            return element.querySelector(name).innerHTML;
        }

    });
</script>