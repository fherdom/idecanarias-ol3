<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!-- Iron elements -->
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!-- Paper elements -->
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-card/paper-card.html">

<dom-module id="idecanarias-ol3">
    <script src="//cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.3/proj4.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/ol3/3.3.0/ol.js"></script>
    <template>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/ol3/3.3.0/ol.css" type="text/css">
        <style>
            :host {
                display: block;
                position: relative;
                font-family: 'Roboto', sans-serif;
            }
            #map {
                height: 100%;
                width: 100%;
            }
            #cards {
                max-width: 250px;
                margin-left: auto;
                margin-right: auto;
            }
            paper-card {
                --paper-card-header: {
                    @apply(--layout-vertical);
                    @apply(--layout-center);
                };
                width: 100%;
                margin-bottom: 16px;
            }
            .pink {
                --paper-card-header-color: var(--paper-pink-500);
            }
        </style>

        <paper-material elevation="1">
            <div id="map"></div>
        </paper-material>

        <iron-ajax
            id="ajax"
            handle-as="xml"
            on-response="handleResponse"
            last-response="{{ xmldata }}">
        </iron-ajax>

        <paper-material>
            <paper-input
                is="iron-input"
                id="btnSearch"
                value="agua"
                bind-value="{{ texto }}"></paper-input>
            <paper-button on-click="doSearch">Buscar</paper-button>
        </paper-material>

        <paper-material>
            <div id="cards">
                <template is="dom-repeat" items="{{ nodeList(xmldata, 'row') }}">
                    <paper-card heading="{{ nodeText(item, 'nombre') }}" class="pink">
                        <div class="card-content">{{ nodeText(item, 'localizacion') }}{{ nodeText(item, 'clasificacion') }}</div>
                        <div class="card-actions">
                            <paper-button>Ir</paper-button>
                        </div>
                    </paper-card>
                </template>
            </div>
        </paper-material>

        <paper-toast id="toast" text="Hello world!"></paper-toast>

    </template>
</dom-module>

<script>
    Polymer(
      {
        is: "idecanarias-ol3",

        properties: {
            name: {
                type: String,
                value: 'Toponimos',
                notify: true
            }
        },

        map: null,

        attached: function() {
            this.async(function() {
                this.initialConfig();
            });
        },

        ready: function() {
            console.debug('ready');
        },

        doSearch: function() {
            var texto = this.$.btnSearch.value;
            this.$.ajax.url = "http://visor.grafcan.es/busquedas/toponimoxml/1/10/";
            this.$.ajax.params = {"texto": texto};
            if (texto) {
                this.$.ajax.generateRequest();
            }
        },

        initialConfig: function(){
            proj4.defs("EPSG:32628","+proj=utm +zone=28 +datum=WGS84 +units=m +no_defs");
            this.map = new ol.Map({
                target: this.$.map,
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.TileWMS({
                            url: "http://idecan3.grafcan.es/ServicioWMS/OrtoExpress?",
                            params: {
                                LAYERS: "ortoexpress",
                                FORMAT: "image/jpeg",
                                VERSION: "1.1.0" },
                            serverType: 'mapserver'
                        })
                    })
                ],
                view: new ol.View({
                    projection: 'EPSG:32628',
                    center: [392216.34, 3143997.71],
                    extent: [180000, 2900000, 680000, 3300000],
                    resolutions: [
                        650, 500, 250, 200,
                        75, 50, 20, 10, 5,
                        2.5, 2, 1.5, 1, 0.5, 0.2, 0.1],
                    units: 'm',
                    resolution: 650
                }),
                controls: ol.control.defaults({
                  attributionOptions: {
                    collapsible: false
                  }
                })
            });
        },

        handleResponse: function(data) {
            var response = data.detail.response;
            list = response.querySelectorAll('row');
            console.log(list);
            this.$.toast.text = 'Consulta realizada';
            this.$.toast.open();
        },

        nodeList: function(element, name) {
            return element ? Array.prototype.slice.call(element.querySelectorAll(name)) : []
        },

        nodeText: function(element, name) {
            return element.querySelector(name).textContent;
        }

    });
</script>